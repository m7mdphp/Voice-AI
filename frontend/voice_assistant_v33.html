<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ±ÙŠØ§Ù‚ V3.2 - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: #1e293b;
            border-radius: 24px;
            padding: 40px;
            max-width: 550px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
        }

        .version {
            font-size: 0.8em;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        h1 {
            color: #38bdf8;
            margin-bottom: 8px;
            font-size: 2.5em;
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
        }

        .status-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: #334155;
            border: 4px solid #475569;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .status-circle.listening {
            background: #059669;
            border-color: #10b981;
            animation: pulse 2s infinite;
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.3);
        }

        .status-circle.thinking {
            background: #d97706;
            border-color: #f59e0b;
            animation: rotate 2s linear infinite;
        }

        .status-circle.speaking {
            background: #dc2626;
            border-color: #ef4444;
            animation: bounce 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.08);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .chat-box {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 16px;
            height: 300px;
            overflow-y: auto;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border: 1px solid #334155;
            scrollbar-width: thin;
            scrollbar-color: #475569 #0f172a;
        }

        .msg {
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 85%;
            font-size: 1.05em;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg.user {
            background: #334155;
            align-self: flex-start;
            color: #f1f5f9;
            border-bottom-right-radius: 4px;
            text-align: right;
        }

        .msg.ai {
            background: #0284c7;
            align-self: flex-end;
            color: white;
            border-bottom-left-radius: 4px;
            text-align: right;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .msg-icon {
            margin-left: 8px;
            font-size: 1.2em;
            vertical-align: middle;
        }

        .btn {
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
            color: #0f172a;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 15px -3px rgba(56, 189, 248, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(56, 189, 248, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .url-box {
            margin-top: 20px;
            background: #1e293b;
            padding: 5px;
            border-radius: 10px;
        }

        .url-box input {
            width: 100%;
            background: transparent;
            border: 1px solid #334155;
            color: #94a3b8;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-family: monospace;
            font-size: 0.9em;
        }

        .debug-info {
            margin-top: 15px;
            font-size: 0.75em;
            color: #64748b;
            padding: 10px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            border-left: 3px solid #38bdf8;
            max-height: 60px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="version">V3.2 - AudioWorklet + Optimized</div>
        <h1>ğŸ©º ØªØ±ÙŠØ§Ù‚</h1>
        <div id="circle" class="status-circle">ğŸ’¤</div>
        <div id="statusText">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡</div>

        <div class="chat-box" id="chat">
            <div class="msg ai"><span class="msg-icon">ğŸ¤–</span>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ. Ø£Ù†Ø§ ØªØ±ÙŠØ§Ù‚ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø·Ø¨ÙŠØ§Ù‹ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
        </div>

        <button id="btn" class="btn" onclick="toggle()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØµÙˆØªÙŠØ©</button>

        <div class="url-box">
            <input type="text" id="url" value="wss://voice.dev.rgeeb.com/ws/session/tiryaq_technology/user_997">
        </div>

        <div class="debug-info" id="debug">ğŸ“Š Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„</div>
    </div>

    <script>
        // ===================== STATE MANAGEMENT =====================
        let ws, audioCtx, stream, workletNode, isPlaying = false, queue = [];
        let audioWorkletReady = false, usingWorklet = false;
        const icons = { idle: 'ğŸ’¤', listening: 'ğŸ™ï¸', thinking: 'âš™ï¸', speaking: 'ğŸ”Š' };

        // ===================== DEBUG HELPER =====================
        function updateDebug(msg) {
            const debug = document.getElementById('debug');
            if (debug) {
                debug.textContent = msg;
            }
            console.log('[DEBUG]', msg);
        }

        // ===================== UI MANAGEMENT =====================
        function setUI(s) {
            const c = document.getElementById('circle');
            c.className = 'status-circle ' + (s || 'idle');
            c.textContent = icons[s] || icons.idle;
            const t = document.getElementById('statusText');
            if (s === 'listening') t.textContent = 'Ø£Ø³ØªÙ…Ø¹ Ø¥Ù„ÙŠÙƒ Ø§Ù„Ø¢Ù†...';
            else if (s === 'thinking') t.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø·Ù„Ø¨Ùƒ...';
            else if (s === 'speaking') t.textContent = 'ÙŠØªØ­Ø¯Ø« ØªØ±ÙŠØ§Ù‚...';
            else t.textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡';
        }

        function addMsg(text, isAI) {
            const chat = document.getElementById('chat');
            let last = chat.lastElementChild;

            if (isAI && last && last.classList.contains('ai') && last.getAttribute('data-finished') === "false") {
                const contentSpan = last.querySelector('.text-content');
                contentSpan.textContent += text;
            } else {
                const d = document.createElement('div');
                d.className = 'msg ' + (isAI ? 'ai' : 'user');

                const icon = document.createElement('span');
                icon.className = 'msg-icon';
                icon.textContent = isAI ? 'ğŸ¤–' : 'ğŸ‘¤';
                d.appendChild(icon);

                const content = document.createElement('span');
                content.className = 'text-content';
                content.textContent = text;
                d.appendChild(content);

                if (isAI) d.setAttribute('data-finished', "false");
                chat.appendChild(d);
            }
            chat.scrollTop = chat.scrollHeight;
        }

        function finishMsg() {
            const chat = document.getElementById('chat');
            const last = chat.lastElementChild;
            if (last && last.classList.contains('ai')) {
                last.setAttribute('data-finished', "true");
            }
        }

        // ===================== AUDIO PLAYBACK =====================
        async function play() {
            if (queue.length === 0 || isPlaying) return;
            isPlaying = true;
            if (!audioCtx) audioCtx = new AudioContext();
            try {
                const buf = await audioCtx.decodeAudioData(queue.shift());
                const src = audioCtx.createBufferSource();
                src.buffer = buf;
                src.connect(audioCtx.destination);
                src.onended = () => { isPlaying = false; play(); };
                src.start(0);
            } catch (e) {
                updateDebug(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª: ${e.message}`);
                isPlaying = false;
                play();
            }
        }

        // ===================== AUDIO WORKLET SETUP =====================
        async function initAudioWorklet() {
            try {
                if (!audioCtx) {
                    audioCtx = new AudioContext({ sampleRate: 16000 });
                }

                if (!audioCtx.audioWorklet) {
                    throw new Error('AudioWorklet ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                }

                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø¹Ø¯Ø© Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø­ØªÙ…Ù„Ø©
                const paths = [
                    'audio-processor.js',
                    './audio-processor.js',
                    '/audio-processor.js',
                    'frontend/audio-processor.js',
                    '/frontend/audio-processor.js'
                ];

                let loaded = false;
                let lastError = null;

                for (const path of paths) {
                    try {
                        await audioCtx.audioWorklet.addModule(path);
                        loaded = true;
                        updateDebug(`âœ… AudioWorklet loaded Ù…Ù†: ${path}`);
                        break;
                    } catch (e) {
                        lastError = e;
                        console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${path} ÙØ´Ù„Øª`, e);
                    }
                }

                if (!loaded) {
                    throw new Error(`Ù„Ù… Ø£Ø³ØªØ·Ø¹ ØªØ­Ù…ÙŠÙ„ AudioWorklet: ${lastError?.message || 'Unknown'}`);
                }

                workletNode = new AudioWorkletNode(audioCtx, 'pcm-processor');

                workletNode.port.onmessage = (event) => {
                    if (ws && ws.readyState === 1 && document.getElementById('circle').classList.contains('listening')) {
                        ws.send(event.data);
                    }
                };

                workletNode.port.onerror = (error) => {
                    updateDebug(`âŒ Ø®Ø·Ø£ ÙÙŠ AudioWorklet: ${error.message}`);
                };

                audioWorkletReady = true;
                usingWorklet = true;
                return true;
            } catch (error) {
                console.warn('AudioWorklet init failed:', error);
                updateDebug(`âš ï¸ AudioWorklet ÙØ´Ù„: ${error.message}`);
                audioWorkletReady = false;
                usingWorklet = false;
                return false;
            }
        }

        // ===================== FALLBACK: ScriptProcessor =====================
        function initScriptProcessor() {
            try {
                if (!audioCtx) {
                    audioCtx = new AudioContext({ sampleRate: 16000 });
                }

                const src = audioCtx.createMediaStreamSource(stream);
                const proc = audioCtx.createScriptProcessor(4096, 1, 1);

                console.warn('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… ScriptProcessor (Deprecated)');
                updateDebug('âš ï¸ ScriptProcessor - Ù‚Ø¯ÙŠÙ… Ù„ÙƒÙ† ÙŠØ¹Ù…Ù„');

                src.connect(proc);
                proc.connect(audioCtx.destination);
                
                proc.onaudioprocess = (e) => {
                    if (ws && ws.readyState === 1 && document.getElementById('circle').classList.contains('listening')) {
                        const input = e.inputBuffer.getChannelData(0);
                        const pcm = new Int16Array(input.length);
                        for (let i = 0; i < input.length; i++) {
                            pcm[i] = Math.max(-32768, Math.min(32767, input[i] * 32768));
                        }
                        ws.send(pcm.buffer);
                    }
                };

                usingWorklet = false;
                return proc;
            } catch (error) {
                updateDebug(`âŒ ScriptProcessor ÙØ´Ù„: ${error.message}`);
                throw error;
            }
        }

        // ===================== MICROPHONE STARTUP =====================
        async function startMic() {
            try {
                updateDebug('ğŸ™ï¸ Ø·Ù„Ø¨ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...');

                if (!stream || !stream.active) {
                    stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: false
                        }
                    });
                }

                if (!audioCtx || audioCtx.state === 'closed') {
                    audioCtx = new AudioContext({ sampleRate: 16000 });
                }

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… AudioWorklet
                let success = false;
                if (!audioWorkletReady) {
                    success = await initAudioWorklet();
                }

                if (success || audioWorkletReady) {
                    try {
                        const src = audioCtx.createMediaStreamSource(stream);
                        src.connect(workletNode);
                        workletNode.connect(audioCtx.destination);
                        updateDebug('âœ… AudioWorklet ÙØ¹Ø§Ù„ - Low Latency!');
                    } catch (e) {
                        console.warn('AudioWorklet connection failed:', e);
                        initScriptProcessor();
                    }
                } else {
                    initScriptProcessor();
                }

                setUI('listening');
            } catch (error) {
                console.error('Mic Error:', error);
                updateDebug(`âŒ Ø®Ø·Ø£: ${error.message}`);
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„ÙƒÙŠ Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø³Ù…Ø§Ø¹Ùƒ");
                setUI('idle');
            }
        }

        // ===================== WebSocket MANAGEMENT =====================
        function toggle() {
            const btn = document.getElementById('btn');
            if (!ws || ws.readyState !== 1) {
                const wsUrl = document.getElementById('url').value;
                updateDebug(`ğŸ”— Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...`);

                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    updateDebug('âœ… WebSocket Ù…ØªØµÙ„');
                    startMic();
                };

                ws.onmessage = async (e) => {
                    try {
                        if (typeof e.data === 'string') {
                            const m = JSON.parse(e.data);
                            if (m.type === 'state') {
                                setUI(m.state);
                            } else if (m.type === 'user_text') {
                                addMsg(m.content, false);
                            } else if (m.type === 'text') {
                                addMsg(m.content, true);
                            } else if (m.type === 'audio_start') {
                                setUI('speaking');
                            } else if (m.type === 'audio_end') {
                                finishMsg();
                                const check = setInterval(() => {
                                    if (queue.length === 0 && !isPlaying) {
                                        clearInterval(check);
                                        ws.send(JSON.stringify({ type: 'playback_done' }));
                                        setUI('listening');
                                    }
                                }, 100);
                            }
                        } else {
                            queue.push(await e.data.arrayBuffer());
                            play();
                        }
                    } catch (err) {
                        console.error('Message processing error:', err);
                    }
                };

                ws.onerror = (error) => {
                    updateDebug(`âŒ Ø®Ø·Ø£: ${error.type}`);
                };

                ws.onclose = () => {
                    updateDebug('âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    setUI('idle');
                    btn.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØµÙˆØªÙŠØ©';
                    btn.style.background = 'linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%)';
                };

                btn.textContent = 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
                btn.style.background = '#ef4444';
            } else {
                updateDebug('ğŸ”Œ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„...');
                ws.close();
            }
        }

        // ===================== INITIALIZATION =====================
        window.addEventListener('load', () => {
            updateDebug('âœ… Ø¬Ø§Ù‡Ø² - Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø±');
        });

        // ===================== CLEANUP =====================
        window.addEventListener('beforeunload', () => {
            if (ws && ws.readyState === 1) {
                ws.close();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>

</html>