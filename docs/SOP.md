# إجراءات التشغيل القياسية (SOP) - المساعد الصوتي "ترياق"

## 1. نظرة عامة (Overview)
هذه الوثيقة تحدد المعايير التقنية والتشغيلية للمساعد الصوتي الذكي "ترياق"، المصمم لتقديم خدمة عملاء فائقة الجودة باستخدام اللهجة السعودية البيضاء، مع التركيز على السرعة (Latency) وتجربة المستخدم السلسة.

---

## 2. هندسة الصوت (Voice Architecture)

يعتمد النظام على تدفق بيانات آني (Real-time Streaming) لضمان استجابة فورية.

### المكونات الأساسية:
1.  **WebRTC Stream:** قناة الاتصال ثنائية الاتجاه لنقل الصوت بجودة عالية.
2.  **Voice Activity Detection (VAD):**
    *   كشف بداية ونهاية الكلام بدقة عالية لتقليل وقت الانتظار.
    *   دعم المقاطعة (Barge-in): عند اكتشاف صوت المستخدم أثناء تحدث المساعد، يتم إيقاف التوليد الصوتي فوراً وإلغاء الاستجابة الحالية.
3.  **Speech-to-Text (STT):** تحويل الصوت إلى نص بدقة عالية مع دعم اللهجة السعودية.
4.  **LLM Brain:** عقل المساعد المسؤول عن معالجة الطلب وتوليد الرد المناسب بالسياق المطلوب.
5.  **Text-to-Speech (TTS):** تحويل النص إلى صوت بشخصية "ترياق" المميزة.

### معالجة الضوضاء (Noise Cancellation Logic):
*   مراقبة مستمرة لمؤشر جودة الصوت (SNR).
*   في حال وجود ضجيج عالي، يتدخل المساعد بأسلوب لبق: *"المعذرة، الجو حولك فيه ضجيج، ما سمعتك زين. ممكن تعيد؟"*

---

## 3. هيكلية قاعدة البيانات (Multi-tenant Firestore Structure)

تم تصميم قاعدة البيانات لضمان العزل التام بين العملاء (Multi-tenancy) وحفظ السياق.

### الهيكل التنظيمي:
*   **العزل (Isolation):** يتم فصل البيانات بناءً على `tenant_id` لضمان الخصوصية والأمان.
*   **المجموعات (Collections):**
    *   `tenants/{tenant_id}/users/{user_id}`: الملف الشخصي للمستخدم.
    *   `sessions/{session_id}`: تفاصيل الجلسة الحالية والذاكرة قصيرة المدى.
    *   `history`: أرشيف المحادثات والملخصات.

### مزامنة الذاكرة (Memory Sync):
1.  **الذاكرة قصيرة المدى:** الاحتفاظ بسياق المحادثة الحالية للرد بذكاء.
2.  **الذاكرة طويلة المدى:**
    *   بعد كل جلسة، يتم توليد ملخص (Summary) وتحديث حقل `long_term_memory` في ملف المستخدم.
    *   عند بدء جلسة جديدة، يتم استدعاء هذا الحقل للترحيب الشخصي: *"هلا [الاسم]، بخصوص موضوعك الأخير.."*.

---

## 4. استراتيجية فرض اللهجة (Dialect Enforcement)

الشخصية هي جوهر "ترياق". نحن لا نتحدث كآلات، بل كموظفين سعوديين محترفين.

### القواعد الصارمة:
1.  **اللهجة:** استخدام "اللهجة البيضاء" فقط. مفهومة لكل المناطق، رسمية لكن ودودة.
2.  **الممنوعات:**
    *   يمنع منعاً باتاً استخدام اللغة العربية الفصحى (إلا في النصوص القانونية).
    *   يمنع الترجمة الحرفية من الإنجليزية (مثل: "كيف يمكنني مساعدتك اليوم؟").
3.  **الأسلوب:**
    *   الترحيب: *"يا هلا والله"، "أبشر، سم"، "تفضل وكلي أذن صاغية"*.
    *   الموافقة: *"أبشر"، "تم"، "على خشمي"*.
    *   الاعتذار: *"المعذرة منك"، "حقك علي"*.

---

## 5. استراتيجية قاتل التأخير (Latency-Killer Unique Strategy)

السرعة هي المعيار الأول لرضا العميل. الهدف هو تقليل الوقت بين انتهاء كلام المستخدم وبدء رد المساعد (Time-to-First-Byte).

### التكتيكات:
1.  **قاعدة الـ 20 كلمة:** الردود يجب أن تكون موجزة جداً (15-20 كلمة كحد أقصى) لتسريع عملية توليد الصوت (TTS).
2.  **المعلومة أولاً (Information First):** الإجابة مباشرة بدون مقدمات طويلة.
    *   *صح:* "مواعيدنا من 8 الصباح لـ 4 العصر."
    *   *خطأ:* "شكراً لسؤالك، يسعدني إعلامك أن أوقات الدوام لدينا تبدأ من الساعة..."
3.  **إزالة الحشو:** حذف الكلمات الزائدة ومحسنات البديع التي لا تضيف قيمة للمعلومة.
4.  **الجسور اللفظية (Fillers):** في حال تطلب البحث وقتاً، استخدم جسراً سريعاً: *"ثواني بس أشوف لك.."* بدلاً من الصمت التام.

---

## 6. بروتوكولات التصعيد والأمان (Escalation & Safety)

### التحويل للموظف البشري (Human Hand-off):
يتم تفعيل "Intelligent Transfer" في الحالات التالية:
1.  تحليل المشاعر (Sentiment Analysis) يظهر غضباً أو إحباطاً (< -0.5).
2.  طلب المستخدم الصريح: *"حولني لموظف"، "أبي آدمي"*.
3.  فشل المساعد في العثور على إجابة موثقة بعد محاولتين.

### عبارة الخروج:
*"أبشر، بحولك الآن للزملاء المختصين يخدمونك بشكل أفضل. ثواني خليك معي."*
